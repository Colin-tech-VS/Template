{% extends "base.html" %}

{% block title %}API Export - Administration{% endblock %}

{% block content %}
<style>
.api-section {
    padding: 60px 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.api-section h2 {
    font-size: 32px;
    color: #1E3A8A;
    font-weight: 700;
    text-align: center;
    margin-bottom: 40px;
}

.api-card {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.api-card h3 {
    color: #1E3A8A;
    font-size: 24px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.api-key-display {
    background: #f8f9fa;
    border: 2px solid #1E3A8A;
    border-radius: 8px;
    padding: 15px;
    font-family: monospace;
    font-size: 14px;
    word-break: break-all;
    margin: 20px 0;
    position: relative;
}

.copy-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #1E3A8A;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s;
}

.copy-btn:hover {
    background: #3B65C4;
}

.btn-danger {
    background: linear-gradient(90deg, #dc3545, #c82333);
    color: white;
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    margin-top: 10px;
}

.btn-danger:hover {
    background: linear-gradient(90deg, #c82333, #bd2130);
    transform: translateY(-2px);
}

.endpoints-list {
    list-style: none;
    padding: 0;
    margin: 20px 0;
}

.endpoint-item {
    background: #f8f9fa;
    border-left: 4px solid #1E3A8A;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 6px;
}

.endpoint-method {
    display: inline-block;
    background: #28a745;
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 700;
    margin-right: 10px;
}

.endpoint-url {
    font-family: monospace;
    font-size: 14px;
    color: #1E3A8A;
    font-weight: 600;
}

.endpoint-description {
    margin-top: 8px;
    color: #555;
    font-size: 14px;
}

.code-block {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 20px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 13px;
    overflow-x: auto;
    margin: 15px 0;
}

.warning-box {
    background: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    color: #856404;
}

.success-box {
    background: #d4edda;
    border: 2px solid #28a745;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    color: #155724;
}

.info-box {
    background: #d1ecf1;
    border: 2px solid #17a2b8;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    color: #0c5460;
}

.api-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.stat-value {
    font-size: 36px;
    font-weight: 700;
    margin: 10px 0;
}

.stat-label {
    font-size: 14px;
    opacity: 0.9;
}
</style>

<section class="api-section">
    <h2>üîå API Export de Donn√©es</h2>

    <!-- CL√â API -->
    <div class="api-card">
        <h3>üîë Cl√© API</h3>
        <p>Utilisez cette cl√© pour authentifier vos requ√™tes d'export. Gardez-la secr√®te !</p>
        
        <div class="api-key-display">
            <strong>Votre cl√© API :</strong><br>
            <span id="api-key">{{ api_key }}</span>
            <button class="copy-btn" onclick="copyApiKey()">üìã Copier</button>
        </div>

        <div class="warning-box">
            ‚ö†Ô∏è <strong>Important :</strong> Ne partagez jamais cette cl√© publiquement. Elle donne acc√®s √† toutes vos donn√©es.
        </div>

        <button class="btn-danger" onclick="regenerateKey()">üîÑ R√©g√©n√©rer une nouvelle cl√©</button>
    </div>

    <!-- ENDPOINTS DISPONIBLES -->
    <div class="api-card">
        <h3>üì° Endpoints Disponibles</h3>
        <p>Tous les endpoints n√©cessitent le header <code>X-API-Key</code> avec votre cl√© API.</p>

        <ul class="endpoints-list">
            <li class="endpoint-item">
                <span class="endpoint-method">GET</span>
                <span class="endpoint-url">/api/export/full</span>
                <div class="endpoint-description">
                    Exporte TOUTES les donn√©es du site (paintings, orders, users, exhibitions, etc.)
                </div>
            </li>

            <li class="endpoint-item">
                <span class="endpoint-method">GET</span>
                <span class="endpoint-url">/api/export/paintings</span>
                <div class="endpoint-description">
                    Exporte uniquement les peintures avec tous leurs d√©tails
                </div>
            </li>

            <li class="endpoint-item">
                <span class="endpoint-method">GET</span>
                <span class="endpoint-url">/api/export/orders</span>
                <div class="endpoint-description">
                    Exporte les commandes avec leurs items associ√©s
                </div>
            </li>

            <li class="endpoint-item">
                <span class="endpoint-method">GET</span>
                <span class="endpoint-url">/api/export/users</span>
                <div class="endpoint-description">
                    Exporte les utilisateurs (sans les mots de passe)
                </div>
            </li>

            <li class="endpoint-item">
                <span class="endpoint-method">GET</span>
                <span class="endpoint-url">/api/export/exhibitions</span>
                <div class="endpoint-description">
                    Exporte toutes les expositions
                </div>
            </li>

            <li class="endpoint-item">
                <span class="endpoint-method">GET</span>
                <span class="endpoint-url">/api/export/custom-requests</span>
                <div class="endpoint-description">
                    Exporte les demandes de cr√©ations personnalis√©es
                </div>
            </li>

            <li class="endpoint-item">
                <span class="endpoint-method">GET</span>
                <span class="endpoint-url">/api/export/settings</span>
                <div class="endpoint-description">
                    Exporte les param√®tres (cl√©s sensibles masqu√©es)
                </div>
            </li>

            <li class="endpoint-item">
                <span class="endpoint-method">GET</span>
                <span class="endpoint-url">/api/export/stats</span>
                <div class="endpoint-description">
                    Exporte des statistiques g√©n√©rales du site
                </div>
            </li>
        </ul>
    </div>

    <!-- EXEMPLE D'UTILISATION -->
    <div class="api-card">
        <h3>üíª Exemple d'utilisation</h3>
        
        <h4>Avec cURL :</h4>
        <div class="code-block">curl -H "X-API-Key: {{ api_key }}" \
     http://127.0.0.1:5000/api/export/full</div>

        <h4>Avec Python :</h4>
        <div class="code-block">import requests

api_key = "{{ api_key }}"
headers = {"X-API-Key": api_key}

# Exporter toutes les donn√©es
response = requests.get(
    "http://127.0.0.1:5000/api/export/full",
    headers=headers
)
data = response.json()
print(data)</div>

        <h4>Avec JavaScript (fetch) :</h4>
        <div class="code-block">const apiKey = "{{ api_key }}";

fetch('http://127.0.0.1:5000/api/export/full', {
    headers: {
        'X-API-Key': apiKey
    }
})
.then(response => response.json())
.then(data => console.log(data));</div>
    </div>

    <!-- FORMAT DE R√âPONSE -->
    <div class="api-card">
        <h3>üìã Format de R√©ponse</h3>
        <p>Toutes les r√©ponses sont au format JSON :</p>
        
        <div class="code-block">{
    "success": true,
    "timestamp": "2025-11-29T10:30:00",
    "data": {
        "paintings": [...],
        "orders": [...],
        "users": [...]
    },
    "tables_count": 10,
    "total_records": 150
}</div>

        <div class="info-box">
            üí° <strong>Astuce :</strong> Utilisez l'endpoint <code>/api/export/stats</code> pour obtenir rapidement un aper√ßu du nombre d'enregistrements dans chaque table.
        </div>
    </div>

    <!-- S√âCURIT√â -->
    <div class="api-card">
        <h3>üîí S√©curit√©</h3>
        <div class="warning-box">
            <strong>Bonnes pratiques :</strong>
            <ul style="margin: 10px 0 0 20px;">
                <li>Ne committez JAMAIS votre cl√© API dans Git</li>
                <li>Stockez-la dans des variables d'environnement</li>
                <li>R√©g√©n√©rez-la si elle est compromise</li>
                <li>Utilisez HTTPS en production</li>
                <li>Limitez l'acc√®s √† cette page aux administrateurs</li>
            </ul>
        </div>
    </div>

    <!-- RETOUR DASHBOARD -->
    <div style="text-align: center; margin-top: 40px;">
        <a href="{{ url_for('admin_dashboard') }}" class="btn-primary" style="display: inline-block; padding: 12px 30px; background: linear-gradient(90deg, #1E3A8A, #3B65C4); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
            ‚Üê Retour au Dashboard
        </a>
    </div>
</section>

<script>
function copyApiKey() {
    const apiKey = document.getElementById('api-key').textContent;
    navigator.clipboard.writeText(apiKey).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = '‚úÖ Copi√© !';
        setTimeout(() => {
            btn.textContent = 'üìã Copier';
        }, 2000);
    });
}

function regenerateKey() {
    if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr ? L\'ancienne cl√© ne fonctionnera plus !')) {
        return;
    }

    fetch('/api/export/regenerate-key', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('api-key').textContent = data.api_key;
            alert('‚úÖ Nouvelle cl√© g√©n√©r√©e avec succ√®s !');
        } else {
            alert('‚ùå Erreur lors de la g√©n√©ration');
        }
    })
    .catch(error => {
        alert('‚ùå Erreur: ' + error);
    });
}
</script>

{% endblock %}
