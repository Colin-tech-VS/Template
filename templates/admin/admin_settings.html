{% extends "base.html" %}

{% block title %}Param√®tres - Admin{% endblock %}

{% block content %}

<header class="admin-header">
    <div class="admin-container">
        <h1>üé® Tableau de bord Admin</h1>
        <nav class="admin-nav">
            <a href="{{ url_for('admin_dashboard') }}" class="nav-btn {% if active=='dashboard' %}active{% endif %}">Dashboard</a>
            <a href="{{ url_for('admin_paintings') }}" class="nav-btn {% if active=='paintings' %}active{% endif %}">Peintures</a>
            <a href="{{ url_for('admin_orders') }}" class="nav-btn {% if active=='orders' %}active{% endif %}">Commandes</a>
            <a href="{{ url_for('admin_users') }}" class="nav-btn {% if active=='users' %}active{% endif %}">Utilisateurs</a>
            <a href="{{ url_for('admin_exhibitions') }}" class="nav-btn {% if active=='exhibitions' %}active{% endif %}">Exhibitions</a>
            <a href="{{ url_for('admin_custom_requests') }}" class="nav-btn {% if active=='custom_requests' %}active{% endif %}">Demandes sur Mesure</a>
            <a href="{{ url_for('admin_notifications') }}" class="nav-btn {% if active=='notifications' %}active{% endif %}">
                üîî Notifications
                {% if new_notifications_count > 0 %}
                <span class="badge">{{ new_notifications_count }}</span>
                {% endif %}
            </a>
            <a href="{{ url_for('admin_settings_page') }}" class="nav-btn {% if active=='settings' %}active{% endif %}">‚öôÔ∏è Param√®tres</a>
            <a href="{{ url_for('add_painting_web') }}" class="nav-btn btn-primary">+ Ajouter</a>
        </nav>
    </div>
</header>

<section class="admin-section">
    <div class="settings-wrapper">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- TABS NAVIGATION -->
        <div class="tabs-navigation">
            <button class="tab-link active" data-tab="identity">üé® Identit√©</button>
            <button class="tab-link" data-tab="pages">üìù Pages</button>
            <button class="tab-link" data-tab="shop">üõçÔ∏è Boutique</button>
            <button class="tab-link" data-tab="integrations">üîß Int√©grations</button>
            <button class="tab-link" data-tab="design">üé≠ Design</button>
        </div>

        <form method="POST" enctype="multipart/form-data" class="settings-form">

            <!-- TAB 1: IDENTIT√â -->
            <div id="identity" class="tab-content active">
                <h2>üé® Identit√© du Site</h2>
                <p class="tab-description">Logo, nom et informations principales</p>

                <div class="form-group">
                    <label for="site_logo">Logo de la Navbar</label>
                    <input type="text" name="site_logo" id="site_logo" value="{{ settings.get('site_logo', 'JB Art') }}" placeholder="JB Art" class="form-input" maxlength="30">
                </div>

                <div class="form-group">
                    <label for="site_name">Nom du site</label>
                    <input type="text" name="site_name" id="site_name" value="{{ settings.get('site_name', 'Jean-Baptiste Art') }}" placeholder="Votre nom de site" class="form-input" maxlength="60">
                </div>

                <div class="form-group">
                    <label for="site_description">Description du site (SEO)</label>
                    <textarea name="site_description" id="site_description" class="form-textarea" maxlength="160" placeholder="Description concise de votre site...">{{ settings.get('site_description', '') }}</textarea>
                    <small>{{ settings.get('site_description', '')|length }}/160 caract√®res</small>
                </div>

                <div class="form-group">
                    <label for="site_keywords">Mots-cl√©s SEO</label>
                    <input type="text" name="site_keywords" id="site_keywords" value="{{ settings.get('site_keywords', '') }}" placeholder="art, peinture, galerie, moderne" class="form-input">
                </div>

                <div class="form-group">
                    <label for="site_slogan">Slogan du site</label>
                    <input type="text" name="site_slogan" id="site_slogan" value="{{ settings.get('site_slogan', '') }}" placeholder="Bienvenue..." class="form-input" maxlength="100">
                </div>
            </div>

            <!-- TAB 2: PAGES -->
            <div id="pages" class="tab-content">
                <h2>üìù Contenu des Pages</h2>
                <p class="tab-description">Accueil, √Ä propos, Galerie, etc.</p>

                <div class="form-group">
                    <label for="home_title">Titre principal de l'accueil</label>
                    <input type="text" name="home_title" id="home_title" value="{{ settings.get('home_title', 'D√©couvrez mes cr√©ations') }}" placeholder="Titre accrocheur" class="form-input" maxlength="80">
                </div>

                <div class="form-group">
                    <label for="home_subtitle">Sous-titre de l'accueil</label>
                    <textarea name="home_subtitle" id="home_subtitle" class="form-textarea" maxlength="200" placeholder="Description...">{{ settings.get('home_subtitle', '') }}</textarea>
                </div>

                <div class="form-group">
                    <label for="about_page_title">Titre page √Ä propos</label>
                    <input type="text" name="about_page_title" id="about_page_title" value="{{ settings.get('about_page_title', '√Ä propos de l\'artiste') }}" placeholder="√Ä propos..." class="form-input" maxlength="80">
                </div>

                <div class="form-group">
                    <label for="site_about">Biographie</label>
                    <textarea name="site_about" id="site_about" class="form-textarea" maxlength="300" placeholder="Bienvenue...">{{ settings.get('site_about', '') }}</textarea>
                </div>

                <div class="form-group">
                    <label for="galerie_title">Titre de la galerie</label>
                    <input type="text" name="galerie_title" id="galerie_title" value="{{ settings.get('galerie_title', 'Galerie des ≈ìuvres') }}" placeholder="Galerie..." class="form-input" maxlength="80">
                </div>

                <div class="form-group">
                    <label for="galerie_description">Description galerie</label>
                    <textarea name="galerie_description" id="galerie_description" class="form-textarea" maxlength="300" placeholder="D√©couvrez...">{{ settings.get('galerie_description', '') }}</textarea>
                </div>

                <div class="form-group">
                    <label for="contact_intro">Introduction page Contact</label>
                    <textarea name="contact_intro" id="contact_intro" class="form-textarea" maxlength="300" placeholder="N'h√©sitez pas...">{{ settings.get('contact_intro', '') }}</textarea>
                </div>

                <div class="form-group">
                    <label for="footer_text">Texte du footer</label>
                    <textarea name="footer_text" id="footer_text" class="form-textarea" placeholder="Artiste passionn√©...">{{ settings.get('footer_text', '') }}</textarea>
                </div>
            </div>

            <!-- TAB 3: BOUTIQUE -->
            <div id="shop" class="tab-content">
                <h2>üõçÔ∏è Boutique & Services</h2>
                <p class="tab-description">Param√®tres boutique et cr√©ations sur mesure</p>

                <div class="form-group">
                    <label for="boutique_title">Titre de la boutique</label>
                    <input type="text" name="boutique_title" id="boutique_title" value="{{ settings.get('boutique_title', 'Boutique en ligne') }}" placeholder="Boutique..." class="form-input" maxlength="80">
                </div>

                <div class="form-group">
                    <label for="boutique_description">Description boutique</label>
                    <textarea name="boutique_description" id="boutique_description" class="form-textarea" maxlength="300" placeholder="Explorez...">{{ settings.get('boutique_description', '') }}</textarea>
                </div>

                <div class="form-group">
                    <label for="expositions_title">Titre des expositions</label>
                    <input type="text" name="expositions_title" id="expositions_title" value="{{ settings.get('expositions_title', 'Expositions') }}" placeholder="Expositions..." class="form-input" maxlength="80">
                </div>

                <div class="form-group">
                    <label for="expositions_description">Description expositions</label>
                    <textarea name="expositions_description" id="expositions_description" class="form-textarea" maxlength="300" placeholder="D√©couvrez...">{{ settings.get('expositions_description', '') }}</textarea>
                </div>

                <div class="form-group checkbox">
                    <input type="checkbox" name="enable_custom_orders" id="enable_custom_orders" value="1" {% if settings.get('enable_custom_orders') == '1' %}checked{% endif %}>
                    <label for="enable_custom_orders">Activer les cr√©ations sur mesure</label>
                </div>
            </div>

            <!-- TAB 4: INT√âGRATIONS -->
            <div id="integrations" class="tab-content">
                <h2>üîß Int√©grations & Services</h2>
                <p class="tab-description">Cl√©s API, Stripe, Email, etc.</p>

                <div class="form-group">
                    <label for="stripe_secret_key">Cl√© secr√®te Stripe</label>
                    <input type="password" name="stripe_secret_key" id="stripe_secret_key" value="{{ settings['stripe_secret_key'] }}" placeholder="sk_live_..." class="form-input">
                </div>

                <div class="form-group">
                    <label for="google_places_key">Cl√© Google Places</label>
                    <input type="text" name="google_places_key" id="google_places_key" value="{{ settings['google_places_key'] }}" placeholder="AIzaSyD..." class="form-input">
                </div>

                <div class="form-group">
                    <label for="ga4_property">GA4 Measurement ID</label>
                    <input type="text" name="ga4_property" id="ga4_property" value="{{ settings.get('ga4_property', '') }}" placeholder="G-XXXXXXXXXX" class="form-input">
                </div>

                <div class="form-group">
                    <label for="email_sender">Email d'envoi</label>
                    <input type="text" name="email_sender" id="email_sender" value="{{ settings['email_sender'] }}" placeholder="contact@example.com" class="form-input">
                </div>

                <div class="form-group">
                    <label for="smtp_password">Mot de passe SMTP</label>
                    <input type="password" name="smtp_password" id="smtp_password" value="{{ settings['smtp_password'] }}" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="form-input">
                </div>

                <!-- CL√â API -->
                <div class="api-key-section">
                    <h3>üîê Cl√© API du Site</h3>
                    <p class="section-hint">Utilisez cette cl√© pour l'int√©gration avec le Dashboard</p>
                    
                    <div class="api-key-box">
                        <div class="api-key-display">
                            <span id="api_key_display" class="api-key-text">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                        </div>
                        <div class="api-key-buttons">
                            <button type="button" class="btn-small" id="toggle_api_key">üëÅÔ∏è Afficher</button>
                            <button type="button" class="btn-small" id="copy_api_key">üìã Copier</button>
                            <button type="button" class="btn-small btn-danger" id="regenerate_api_key">üîÑ R√©g√©n√©rer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 5: DESIGN -->
            <div id="design" class="tab-content">
                <h2>üé≠ Th√®me des Couleurs</h2>
                <p class="tab-description">Personnalisez la palette de votre site</p>

                <div class="color-grid">
                    <div class="color-item">
                        <label for="primary_color">Couleur primaire</label>
                        <input type="color" name="primary_color" id="primary_color" value="{{ settings['primary_color'] }}" class="color-picker">
                        <span class="color-value">{{ settings['primary_color'] }}</span>
                    </div>

                    <div class="color-item">
                        <label for="secondary_color">Couleur secondaire</label>
                        <input type="color" name="secondary_color" id="secondary_color" value="{{ settings['secondary_color'] }}" class="color-picker">
                        <span class="color-value">{{ settings['secondary_color'] }}</span>
                    </div>

                    <div class="color-item">
                        <label for="accent_color">Couleur d'accentuation</label>
                        <input type="color" name="accent_color" id="accent_color" value="{{ settings['accent_color'] }}" class="color-picker">
                        <span class="color-value">{{ settings['accent_color'] }}</span>
                    </div>

                    <div class="color-item">
                        <label for="button_text_color">Texte des boutons</label>
                        <input type="color" name="button_text_color" id="button_text_color" value="{{ settings.get('button_text_color', '#FFFFFF') }}" class="color-picker">
                        <span class="color-value">{{ settings.get('button_text_color', '#FFFFFF') }}</span>
                    </div>

                    <div class="color-item">
                        <label for="content_text_color">Texte du contenu</label>
                        <input type="color" name="content_text_color" id="content_text_color" value="{{ settings.get('content_text_color', '#000000') }}" class="color-picker">
                        <span class="color-value">{{ settings.get('content_text_color', '#000000') }}</span>
                    </div>

                    <div class="color-item">
                        <label for="button_hover_color">Couleur au survol</label>
                        <input type="color" name="button_hover_color" id="button_hover_color" value="{{ settings.get('button_hover_color', '#9C27B0') }}" class="color-picker">
                        <span class="color-value">{{ settings.get('button_hover_color', '#9C27B0') }}</span>
                    </div>
                </div>
            </div>

            <!-- SAVE BUTTON -->
            <div class="form-actions">
                <button type="submit" class="btn-save">üíæ Sauvegarder tous les param√®tres</button>
            </div>
        </form>
    </div>
</section>

    <!-- LIVE COLOR PREVIEW (placed here to appear under the Design tab) -->
    <div style="max-width:1000px;margin:10px auto 40px;padding:0 20px;">
        <div id="color_preview_panel_wrapper">
            <h3>Aper√ßu des couleurs appliqu√©es</h3>
            <p class="section-hint">Visualisez la palette actuelle du site. Les changements via les s√©lecteurs de couleur mettent √† jour cet aper√ßu en direct.</p>

            <div class="preview-card" id="color_preview_card">
                <div class="preview-navbar">Logo</div>
                <div class="preview-hero">
                    <h4>Bienvenue ‚Äî Aper√ßu</h4>
                    <p class="preview-content">Ceci est un exemple de texte pour v√©rifier la couleur du contenu.</p>
                    <div class="preview-actions">
                        <button class="preview-btn">Call to action</button>
                        <button class="preview-btn preview-secondary">Secondaire</button>
                    </div>
                </div>
                <div class="preview-swatches">
                    <div class="swatch"><div class="swatch-sample swatch-primary"></div><span>Primaire</span></div>
                    <div class="swatch"><div class="swatch-sample swatch-secondary"></div><span>Secondaire</span></div>
                    <div class="swatch"><div class="swatch-sample swatch-accent"></div><span>Accent</span></div>
                    <div class="swatch"><div class="swatch-sample swatch-button-text"></div><span>Texte bouton</span></div>
                    <div class="swatch"><div class="swatch-sample swatch-content-text"></div><span>Texte contenu</span></div>
                </div>
            </div>
        </div>
    </div>

<style>
* {
    box-sizing: border-box;
}

.settings-wrapper {
    max-width: 1000px;
    margin: 30px auto;
    padding: 0 20px;
}

/* TABS NAVIGATION */
.tabs-navigation {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    border-bottom: 2px solid #e2e8f0;
    overflow-x: auto;
    flex-wrap: wrap;
}

.tab-link {
    padding: 15px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    color: #718096;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.tab-link:hover {
    color: #2d3748;
    background: #f7fafc;
}

.tab-link.active {
    color: #1E3A8A;
    border-bottom-color: #1E3A8A;
}

/* TAB CONTENT */
.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tab-content h2 {
    margin-top: 0;
    color: #1a202c;
    font-size: 24px;
}

.tab-description {
    color: #718096;
    margin-bottom: 30px;
    font-size: 15px;
}

/* FORMS */
.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2d3748;
    font-size: 14px;
}

.form-input,
.form-textarea {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
}

.form-input:focus,
.form-textarea:focus {
    outline: none;
    border-color: #1E3A8A;
    box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.form-group small {
    display: block;
    margin-top: 5px;
    color: #718096;
    font-size: 12px;
}

/* CHECKBOX */
.form-group.checkbox {
    display: flex;
    align-items: center;
    margin-top: 15px;
}

.form-group.checkbox input {
    margin-right: 10px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.form-group.checkbox label {
    margin: 0;
    cursor: pointer;
}

/* COLORS */
.color-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.color-item {
    display: flex;
    flex-direction: column;
}

.color-item label {
    margin-bottom: 10px;
}

.color-picker {
    width: 100%;
    height: 60px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    cursor: pointer;
    transition: border-color 0.2s ease;
}

.color-picker:hover {
    border-color: #cbd5e0;
}

.color-value {
    margin-top: 8px;
    font-family: monospace;
    color: #718096;
    font-size: 13px;
    text-align: center;
}

/* API KEY */
.api-key-section {
    background: #f7fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 25px;
    margin-top: 30px;
}

.api-key-section h3 {
    margin-top: 0;
    color: #1a202c;
    font-size: 18px;
}

.section-hint {
    color: #718096;
    font-size: 14px;
    margin-bottom: 20px;
}

.api-key-box {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}

.api-key-display {
    flex: 1;
    min-width: 250px;
}

.api-key-text {
    display: block;
    padding: 15px;
    background: white;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    font-family: monospace;
    font-size: 13px;
    word-break: break-all;
    color: #2d3748;
}

.api-key-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* BUTTONS */
.btn-small {
    padding: 12px 16px;
    background: #4299e1;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-small:hover {
    background: #3182ce;
    transform: translateY(-1px);
}

.btn-small.btn-danger {
    background: #ed8936;
}

.btn-small.btn-danger:hover {
    background: #dd6b20;
}

.form-actions {
    display: flex;
    justify-content: center;
    margin-top: 40px;
}

.btn-save {
    padding: 16px 40px;
    background: linear-gradient(90deg, var(--color-primary, #1E3A8A), var(--color-secondary, #3B65C4));
    color: var(--button-text-color, white);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15);
}

.btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(30, 58, 138, 0.25);
}

/* ALERTS */
.alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid;
    font-size: 14px;
}

.alert-success {
    background: #f0fdf4;
    color: #166534;
    border-color: #22c55e;
}

.alert-danger {
    background: #fef2f2;
    color: #991b1b;
    border-color: #ef4444;
}

/* MOBILE */
@media (max-width: 768px) {
    .tabs-navigation {
        gap: 5px;
    }

    .tab-link {
        padding: 12px 15px;
        font-size: 13px;
    }

    .color-grid {
        grid-template-columns: 1fr;
    }

    .api-key-box {
        flex-direction: column;
    }

    .api-key-buttons {
        width: 100%;
    }

    .btn-small {
        flex: 1;
    }
}

/* ------------------ Preview styles ------------------ */
.preview-card {
    border: 1px solid #e6eef8;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(15,23,42,0.06);
}
.preview-navbar {
    padding: 12px 18px;
    background: var(--color-secondary, #3B65C4);
    color: var(--button-text-color, #fff);
    font-weight: 700;
}
.preview-hero {
    padding: 24px;
    background: linear-gradient(180deg, var(--color-primary, #1E3A8A), var(--color-secondary, #3B65C4));
    color: var(--button-text-color, #fff);
}
.preview-hero h4 { margin: 0 0 8px; }
.preview-content { color: var(--content-text-color, #000); margin-bottom: 12px; }
.preview-actions { display:flex; gap:12px; }
.preview-btn {
    padding: 10px 16px;
    background: var(--color-primary, #1E3A8A);
    color: var(--button-text-color, #fff);
    border: none;
    border-radius: 8px;
    cursor: pointer;
}
.preview-btn.preview-secondary { background: var(--color-secondary, #3B65C4); }
.preview-btn:hover { background: var(--button-hover-color, #9C27B0); }
.preview-swatches { display:flex; gap:12px; padding:14px; align-items:center; }
.swatch { display:flex; align-items:center; gap:8px; font-size:13px; color:#374151; }
.swatch-sample { width:28px; height:20px; border-radius:4px; border:1px solid rgba(0,0,0,0.08); }
.swatch-primary { background: var(--color-primary, #1E3A8A); }
.swatch-secondary { background: var(--color-secondary, #3B65C4); }
.swatch-accent { background: var(--color-accent, #FF7F50); }
.swatch-button-text { background: var(--button-text-color, #fff); border:1px solid #e2e8f0; }
.swatch-content-text { background: var(--content-text-color, #000); }
</style>

<script>
let currentApiKey = null;
let isApiKeyVisible = false;

// Tabs switching
document.querySelectorAll('.tab-link').forEach(button => {
    button.addEventListener('click', function() {
        const tabId = this.dataset.tab;
        
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-link').forEach(link => {
            link.classList.remove('active');
        });
        
        document.getElementById(tabId).classList.add('active');
        this.classList.add('active');
    });
});

// Load API Key
function loadApiKey() {
    fetch('/api/export/api-key')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.api_key) {
                currentApiKey = data.api_key;
                updateApiKeyDisplay();
            }
        })
        .catch(e => console.error('Error:', e));
}

function updateApiKeyDisplay() {
    const display = document.getElementById('api_key_display');
    if (isApiKeyVisible) {
        display.textContent = currentApiKey;
    } else {
        const masked = currentApiKey.substring(0, 8) + '‚Ä¢'.repeat(Math.max(0, currentApiKey.length - 16)) + currentApiKey.substring(currentApiKey.length - 8);
        display.textContent = masked;
    }
}

// API Key buttons
document.getElementById('toggle_api_key')?.addEventListener('click', function(e) {
    e.preventDefault();
    isApiKeyVisible = !isApiKeyVisible;
    this.textContent = isApiKeyVisible ? 'üëÅÔ∏è‚Äçüó®Ô∏è Masquer' : 'üëÅÔ∏è Afficher';
    updateApiKeyDisplay();
});

document.getElementById('copy_api_key')?.addEventListener('click', function(e) {
    e.preventDefault();
    if (currentApiKey) {
        navigator.clipboard.writeText(currentApiKey).then(() => {
            this.textContent = '‚úì Copi√©!';
            setTimeout(() => this.textContent = 'üìã Copier', 2000);
        });
    }
});

document.getElementById('regenerate_api_key')?.addEventListener('click', function(e) {
    e.preventDefault();
    if (confirm('√ätes-vous s√ªr? Cela invalidera la cl√© actuelle.')) {
        fetch('/api/export/regenerate-key', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    currentApiKey = data.api_key;
                    isApiKeyVisible = false;
                    updateApiKeyDisplay();
                    document.getElementById('toggle_api_key').textContent = 'üëÅÔ∏è Afficher';
                    alert('Cl√© r√©g√©n√©r√©e!');
                }
            });
    }
});

// Color pickers
document.querySelectorAll('.color-picker').forEach(picker => {
    const valueDisplay = picker.parentElement.querySelector('.color-value');
    if (valueDisplay) {
        picker.addEventListener('change', function() {
            valueDisplay.textContent = this.value.toUpperCase();
            // update live preview variables when user changes a picker
            const preview = document.getElementById('color_preview_card');
            if (preview) {
                const name = this.id; // e.g. primary_color
                // map input id to CSS variable name
                const map = {
                    primary_color: '--color-primary',
                    secondary_color: '--color-secondary',
                    accent_color: '--color-accent',
                    button_text_color: '--button-text-color',
                    content_text_color: '--content-text-color',
                    button_hover_color: '--button-hover-color'
                };
                const varName = map[name];
                if (varName) preview.style.setProperty(varName, this.value);
                // also update swatches if present
                document.querySelectorAll('.swatch-primary').forEach(el=>el.style.background=this.value);
            }
        });
    }
});

// Load colors from the server-generated dynamic CSS and apply to preview
function loadPreviewColorsFromDynamicCss() {
    fetch('/dynamic-colors.css', { cache: 'no-store' })
        .then(r => r.text())
        .then(text => {
            // parse CSS variables from :root
            const vars = {};
            const rx = /--([a-z0-9-]+)\s*:\s*([^;]+);/gi;
            let m;
            while ((m = rx.exec(text)) !== null) {
                vars[m[1]] = m[2].trim();
            }
            const preview = document.getElementById('color_preview_card');
            if (preview) {
                Object.keys(vars).forEach(k => preview.style.setProperty('--' + k, vars[k]));
                // update swatches
                if (vars['color-primary']) document.querySelectorAll('.swatch-primary').forEach(el=>el.style.background=vars['color-primary']);
                if (vars['color-secondary']) document.querySelectorAll('.swatch-secondary').forEach(el=>el.style.background=vars['color-secondary']);
                if (vars['color-accent']) document.querySelectorAll('.swatch-accent').forEach(el=>el.style.background=vars['color-accent']);
                if (vars['button-text-color']) document.querySelectorAll('.swatch-button-text').forEach(el=>el.style.background=vars['button-text-color']);
                if (vars['content-text-color']) document.querySelectorAll('.swatch-content-text').forEach(el=>el.style.background=vars['content-text-color']);
            }
        })
        .catch(e => console.warn('Could not load dynamic colors preview:', e));
}

document.addEventListener('DOMContentLoaded', function() {
    loadPreviewColorsFromDynamicCss();
});

document.addEventListener('DOMContentLoaded', loadApiKey);
</script>

{% endblock %}
