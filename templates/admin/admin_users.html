{% extends "admin/base_admin.html" %}

{% block title %}Utilisateurs - Admin{% endblock %}

{% block admin_content %}

<!-- PAGE HEADER -->
<div class="admin-page-header">
    <div class="admin-page-header-left">
        <h2 class="admin-page-title">ğŸ‘¥ Utilisateurs</h2>
        <p class="admin-page-subtitle">{{ users|length }} utilisateur{{ 's' if users|length > 1 else '' }} inscrit{{ 's' if users|length > 1 else '' }}</p>
    </div>
    <div class="admin-page-actions">
        <a href="{{ url_for('export_users') }}" class="admin-btn admin-btn-secondary">ğŸ“¥ Exporter</a>
    </div>
</div>

<!-- FILTERS AND ACTIONS -->
<div class="admin-card" style="margin-bottom: 24px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- SEARCH FORM -->
        <form method="get" action="{{ url_for('admin_users') }}" class="admin-search-form">
            <input type="text" name="q" placeholder="ğŸ” Rechercher par nom, email..." value="{{ request.args.get('q', '') }}" class="admin-search-input">
            <button type="submit" class="admin-btn admin-btn-primary">Chercher</button>
        </form>
        
        <!-- ROLE FILTER -->
        <form method="get" action="{{ url_for('admin_users') }}" style="display: flex; gap: 12px; align-items: flex-end;">
            <div style="flex: 1;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--color-text);">Filtrer par rÃ´le</label>
                <select name="role" class="admin-form-select" onchange="this.form.submit()" style="width: 100%;">
                    <option value="" {% if not request.args.get('role') %}selected{% endif %}>Tous les rÃ´les</option>
                    <option value="user" {% if request.args.get('role')=='user' %}selected{% endif %}>ğŸ‘¤ Utilisateur</option>
                    <option value="partenaire" {% if request.args.get('role')=='partenaire' %}selected{% endif %}>ğŸ¤ Partenaire</option>
                    <option value="admin" {% if request.args.get('role')=='admin' %}selected{% endif %}>ğŸ‘‘ Admin</option>
                </select>
            </div>
        </form>
    </div>
    
    <!-- ACTION BUTTONS -->
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="admin-btn admin-btn-primary" onclick="openEmailModal('user')">ğŸ“§ Mail utilisateurs</button>
        <button class="admin-btn admin-btn-primary" onclick="openEmailModal('partenaire')">ğŸ“§ Mail partenaires</button>
    </div>
</div>

<!-- USERS TABLE -->
{% if users %}
<div class="admin-card">
    <div class="admin-table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>RÃ´le</th>
                    <th>Inscrit le</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td><strong>#{{ user.id }}</strong></td>
                    <td>{{ user.name }}</td>
                    <td style="font-size: 0.9rem;">{{ user.email }}</td>
                    <td>
                        <span class="admin-badge {% if user.role == 'admin' %}admin-badge-danger{% elif user.role == 'partenaire' %}admin-badge-warning{% else %}admin-badge-primary{% endif %}">
                            {% if user.role == 'admin' %}ğŸ‘‘ Admin
                            {% elif user.role == 'partenaire' %}ğŸ¤ Partenaire
                            {% else %}ğŸ‘¤ Utilisateur
                            {% endif %}
                        </span>
                    </td>
                    <td style="font-size: 0.9rem; color: #6b7280;">{{ user.create_date }}</td>
                    <td>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <a href="mailto:{{ user.email }}" class="admin-btn admin-btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;">âœ‰ï¸</a>
                            
                            {% if user.role == 'admin' and user.email != 'coco.cayre@gmail.com' %}
                            <form method="post" action="{{ url_for('update_user_role', user_id=user.id) }}" style="display: inline;" onsubmit="return confirm('ÃŠtes-vous sÃ»r ?');">
                                <input type="hidden" name="role" value="user">
                                <button type="submit" class="admin-btn admin-btn-danger" style="padding: 6px 12px; font-size: 0.85rem;">Retirer</button>
                            </form>
                            {% elif user.role != 'admin' %}
                            <select name="role" onchange="updateUserRole(this, {{ user.id }})" class="admin-form-select" style="padding: 6px 12px; font-size: 0.85rem;">
                                <option value="user" {% if user.role=='user' %}selected{% endif %}>ğŸ‘¤ Utilisateur</option>
                                <option value="partenaire" {% if user.role=='partenaire' %}selected{% endif %}>ğŸ¤ Partenaire</option>
                                <option value="admin" {% if user.role=='admin' %}selected{% endif %}>ğŸ‘‘ Admin</option>
                            </select>
                            {% else %}
                            <span class="admin-badge admin-badge-danger">ğŸ”’ ProtÃ©gÃ©</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="admin-empty-state">
    <div class="admin-empty-icon">ğŸ‘¥</div>
    <h3 class="admin-empty-title">Aucun utilisateur</h3>
    <p class="admin-empty-message">Aucun utilisateur trouvÃ©</p>
</div>
{% endif %}

<!-- EMAIL MODAL -->
<div id="emailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
    <div class="admin-card" style="max-width: 500px; width: 90%; border-radius: 12px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <h3 id="modalTitle" style="margin: 0; font-size: 1.25rem; color: var(--color-text);">Envoyer un mail</h3>
            <button onclick="closeEmailModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">âœ•</button>
        </div>
        
        <form method="post" action="{{ url_for('send_email_role') }}" class="admin-form">
            <input type="hidden" name="role" id="modalRole">
            
            <div class="admin-form-group">
                <label class="admin-form-label">Objet</label>
                <input type="text" name="subject" id="subject" required class="admin-form-input" placeholder="Objet du message...">
            </div>
            
            <div class="admin-form-group">
                <label class="admin-form-label">Message</label>
                <textarea name="message" id="message" rows="6" required class="admin-form-textarea" placeholder="Votre message..."></textarea>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button type="submit" class="admin-btn admin-btn-primary">ğŸ“§ Envoyer</button>
                <button type="button" onclick="closeEmailModal()" class="admin-btn admin-btn-secondary">Annuler</button>
            </div>
        </form>
    </div>
</div>

<script>
function openEmailModal(role) {
    const modal = document.getElementById('emailModal');
    const roleInput = document.getElementById('modalRole');
    const titleEl = document.getElementById('modalTitle');
    
    roleInput.value = role;
    if (role === 'user') {
        titleEl.textContent = 'Envoyer un mail Ã  tous les utilisateurs';
    } else {
        titleEl.textContent = 'Envoyer un mail Ã  tous les partenaires';
    }
    modal.style.display = 'flex';
}

function closeEmailModal() {
    document.getElementById('emailModal').style.display = 'none';
}

function updateUserRole(select, userId) {
    const newRole = select.value;
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("update_user_role", user_id="USERID") }}'.replace('USERID', userId);
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'role';
    input.value = newRole;
    
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('emailModal');
    if (event.target == modal) {
        closeEmailModal();
    }
}
</script>

{% endblock %}
